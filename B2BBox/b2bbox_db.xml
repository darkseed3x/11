<?xml version="1.0" encoding="UTF-8"?>
<con:testCase id="47561141-dab3-4936-82c6-a510d952e39c" failOnError="true" failTestCaseOnErrors="true" keepSession="false" maxResults="0" name="b2bbox_db" searchProperties="true" xmlns:con="http://eviware.com/soapui/config"><con:settings><con:setting id="47561141-dab3-4936-82c6-a510d952e39cfileName">b2bbox_db</con:setting></con:settings><con:testStep type="groovy" name="setProperty" id="9fdd0eab-23e0-4287-883c-98d7a9eeb2de"><con:settings/><con:config><script>import javax.swing.*

def map = testRunner.testCase.getProperties()
def t= map.each{
    key, value -> testRunner.testCase.setPropertyValue(key, "")
}


JTextField sims = new JTextField();

 JOptionPane.showConfirmDialog(null, sims, "Введите кол-во сим", JOptionPane.OK_CANCEL_OPTION);
 
 int counter = 0;
def text = sims.getText();
if(text.isInteger()){
	text = text as Integer;
	if( text &lt;= 20 &amp;&amp; text > 0){
	 	counter  = text;
	}else{
		counter = 10;
		}
}else{
	counter = 1;
	}
testRunner.testCase.setPropertyValue('SIMCount', counter.toString());
testRunner.testCase.setPropertyValue('N', "0");
testRunner.testCase.setPropertyValue('path', "C:/Projects/");


</script></con:config></con:testStep><con:testStep type="datasource" name="DB" id="fc1d5a72-a88c-4f32-b3b2-eef43fec4ccd"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.teststeps.WsdlDataSourceTestStep@prepared-properties">&lt;xml-fragment/></con:setting></con:settings><con:config xsi:type="con:DataSourceStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:dataSource type="JDBC"><con:configuration><driver>oracle.jdbc.driver.OracleDriver</driver><connstr>jdbc:oracle:thin:${#Project#CBOSS_ENV}/PASS_VALUE@${#Project#cbossDBHost}:${#Project#cbossDBPort}</connstr><pass>${#Project#cbossDBPassword}</pass><Connection/><query>SELECT sc.icc_id
  FROM sim_card sc, unit u
 WHERE     SYSDATE BETWEEN sc.fd AND sc.td
       AND sc.status = 1
       AND u.ser_num = sc.icc_id
       AND u.td = TO_DATE('01019999', 'ddmmyyyy')
       AND u.UP = '442'
       AND u.code = 'PHONE-001'
       AND ROWNUM &lt;= 10000
       ORDER BY DBMS_RANDOM.random</query><fetchSize/><stored-procedure>false</stored-procedure></con:configuration></con:dataSource><con:property>icc_id</con:property><con:restartOnRun>true</con:restartOnRun></con:config></con:testStep><con:testStep type="restrequest" name="putBranch" id="05484e49-753a-4f04-bf91-5efec03dcc25"><con:settings/><con:config service="Billing API" resourcePath="/bill/v1/sim/info" methodName="setSIMInformation" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="putBranch" id="e4a51fec-a8f9-40a0-9937-858a67d49b31" mediaType="application/json" postQueryString="false"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://${#Project#billapi}:8080</con:endpoint><con:request>{"imsis": [{
   "imsi": "25011${DB#icc_id}",
   "attrs":    [
            {
         "attrType": "branch",
         "attrValue": "YOTA-001"
      },
            {
         "attrType": "simSpec",
         "attrValue": "PHONELEGAL"
      }
   ]
}]}</con:request><con:originalUri>http://ft3-bil-api.g4lab.com/bill/v1/sim/info</con:originalUri><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:restRequest></con:config></con:testStep><con:testStep type="restrequest" name="getsimInfo" id="d4eb1801-15dd-40e4-97ec-0c058f7d5194"><con:settings/><con:config service="Billing API" resourcePath="/bill/v1/sim/info" methodName="getSIMInformation" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="getsimInfo" id="25163017-c7d8-4fd3-9cad-5b19eb39ba0f" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://${#Project#billapi}:8080</con:endpoint><con:request/><con:originalUri>http://ft2-bil-api.g4lab.com/bill/v1/sim/info</con:originalUri><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><entry key="iccids" value="${DB#icc_id}" xmlns="http://eviware.com/soapui/config"/></con:parameters></con:restRequest></con:config></con:testStep><con:testStep type="groovy" name="Copy of checkIS" id="ed913833-94ac-489f-a9e7-8d857138e33c" disabled="true"><con:settings/><con:config><script>
String spec = context.expand( '${getsimInfo#Response#$[0].attributes[1].attrValue}' )
String vacant = context.expand( '${getsimInfo#Response#$[0].status}' )

 if ( !vacant.equals("vacant"))
{
  testRunner.gotoStepByName("DB")
}
if(!spec.equals("PHONELEGAL") ){
	testRunner.runTestStepByName("putBranch")
	}
</script></con:config></con:testStep><con:testStep type="request" name="cams" id="0f1d4420-97c9-4d8d-910e-32b3ac82a566"><con:settings/><con:config xsi:type="con:RequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:interface>CustomerAccountServiceSOAPBinding</con:interface><con:operation>checkSimAvailability</con:operation><con:request name="cams" id="79671178-8731-441e-a0f8-12f6e1cdd458"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:encoding>UTF-8</con:encoding><con:endpoint>http://${#Project#host-b2b}:8315/CustomerAccountManagementService</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:cus="http://www.yota.ru/vox/b2b/services/customerAccount">
   <soapenv:Header/>
   <soapenv:Body>
      <cus:CheckSimAvailabilityRequest>
         <iccid>${DB#icc_id}</iccid>
      </cus:CheckSimAvailabilityRequest>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="SOAP Response" id="2cb0e524-0f78-43f8-b31b-69f96b839530"/><con:credentials><con:selectedAuthProfile>Basic</con:selectedAuthProfile><con:addedBasicAuthenticationTypes>Basic</con:addedBasicAuthenticationTypes><con:authType>Global HTTP Settings</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:wsaConfig mustUnderstand="NONE" version="200508"/><con:wsrmConfig version="1.2"/></con:request></con:config></con:testStep><con:testStep type="groovy" name="Copy of checkCams" id="d196bfd4-1a57-42d4-9447-af15c4ffb561"><con:settings/><con:config><script>def checksim = context.expand( '${cams#Response#declare namespace ns0=\'http://www.yota.ru/vox/b2b/services/customerAccount\'; //ns0:CheckSimAvailabilityResponse[1]/validationResult[1]}' )

 if (checksim != 'true')
{
  testRunner.gotoStepByName("DB")
}</script></con:config></con:testStep><con:testStep type="restrequest" name="delSubscr" id="dcfaed37-beb8-4f18-8345-24ca67cb7063"><con:settings/><con:config service="http://helper.api" resourcePath="/spr/sm/deleteSubscriber" methodName="deleteSubscriber" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="delSubscr" id="8c245147-868c-4630-a85c-b8a1f8b88e06" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://${#Project#pcrfHost}</con:endpoint><con:request/><con:originalUri>http://pcrf-api.g4lab.com/spr/sm/deleteSubscriber</con:originalUri><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><entry key="id" value="25011${DB#icc_id}" xmlns="http://eviware.com/soapui/config"/></con:parameters></con:restRequest></con:config></con:testStep><con:testStep type="restrequest" name="addSubscr" id="f6d4bf37-9812-4494-8949-01df537fce9b"><con:settings/><con:config service="http://helper.api" resourcePath="/spr/sm/addSubscriber" methodName="addSubscriber" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="addSubscr" id="dfd4caeb-8349-4ee0-9009-ddd77a9b1f6a" mediaType="application/json"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://${#Project#pcrfHost}</con:endpoint><con:request/><con:originalUri>http://pcrf-api.g4lab.com/spr/sm/addSubscriber</con:originalUri><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters><entry key="id" value="25011${DB#icc_id}" xmlns="http://eviware.com/soapui/config"/></con:parameters></con:restRequest></con:config></con:testStep><con:testStep type="request" name="validationsim" id="8bec084f-2538-40d8-a394-d150c5ed2f62"><con:settings/><con:config xsi:type="con:RequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:interface>CorporateOrderManagementServiceSOAPBinding</con:interface><con:operation>getOrderByCriteria</con:operation><con:request name="validationsim" id="9e11c1fd-ed8c-4a4d-8a5c-4d2f3f6a6e0d"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:encoding>UTF-8</con:encoding><con:endpoint>http://${#Project#host-b2b}:8082/oms-web/OrderEndpoint</con:endpoint><con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:ord="http://www.yota.ru/vox/b2b/services/order">
   <soapenv:Header/>
   <soapenv:Body>
      <ord:GetOrderByCriteriaRequest>
         <iccid>${DB#icc_id}</iccid>
         <orderType>b2bBox</orderType>
      </ord:GetOrderByCriteriaRequest>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request><con:assertion type="SOAP Response" id="1400ac48-9a4e-4a7b-9674-93e0131f0517"/><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:wsaConfig mustUnderstand="NONE" version="200508"/><con:wsrmConfig version="1.2"/></con:request></con:config></con:testStep><con:testStep type="groovy" name="add iccid" id="bdc5f1ee-7919-431e-a18c-0fd0a6058e68"><con:settings/><con:config><script>
def orderId = context.expand( '${validationsim#Response#declare namespace ns7=\'http://www.yota.ru/vox/b2b/services/order\'; //ns7:GetOrderByCriteriaResponse[1]/order[1]/orderId[1]}' )


if(orderId){	
	testRunner.gotoStepByName("DB")

}else{
	int N = context.expand( '${#TestCase#N}' ).toInteger()
	int SIMCount = context.expand( '${#TestCase#SIMCount}' ).toInteger()
	
	N++
	def iccidName = "iccid" + N
	testRunner.testCase.setPropertyValue(iccidName, context.expand('${DB#icc_id}'));
	testRunner.testCase.setPropertyValue("N", N.toString() )
	
	 if (N &lt; SIMCount){
	 	
		testRunner.gotoStepByName("DB")
	}
	}</script></con:config></con:testStep><con:testStep type="groovy" name="buildJson" id="82ba871d-dd6a-47a0-a37c-39c2603f2317"><con:settings/><con:config><script>import groovy.json.JsonBuilder 
import groovy.json.JsonOutput 

def testRequest = context.testCase.testSteps["B_2_B_BOX_order"].testRequest
def request = testRequest.requestContent;

def SIMCount = context.expand( '${#TestCase#SIMCount}' ).toInteger()

def iccidBlock =[]


for(int i = 1; i &lt;= SIMCount; i++){
	iccidBlock.add('${#TestCase#iccid' + i + '}')
def iccid1 = context.expand( '${#TestCase#iccid1}' )
	}

JsonBuilder builder = new JsonBuilder()
builder.order {
        createChannel 'PUBLIC_PORTAL'
        orderStatus 'INITIATE'
        orderStep 'INITIALIZATION'
        orderType 'B_2_B_BOX'
        updateChannel 'PUBLIC_PORTAL'
        orderContent{
        		B2BBoxOrder {
        				delivery 'false'
        				iccid (iccidBlock)
        		}
        }     
}



String json = JsonOutput.prettyPrint(builder.toString())
log.info json
testRequest.setRequestContent(json);
</script></con:config></con:testStep><con:testStep type="restrequest" name="B_2_B_BOX_order" id="cdc8f8a5-4b76-47a5-8fba-44b2b4e4638b"><con:settings/><con:config service="Corporate Order Management Service (CorpOMS)" resourcePath="/coms-web/api/createOrder" methodName="createOrder" xsi:type="con:RestRequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"><con:restRequest name="B_2_B_BOX_order" id="978de5b9-fe46-4a0d-870c-8ad76d390f25" mediaType="application/json" postQueryString="false"><con:settings><con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting></con:settings><con:endpoint>http://${#Project#host-b2b-rest}:8062</con:endpoint><con:request>{
    "order": {
        "createChannel": "PUBLIC_PORTAL",
        "orderStatus": "INITIATE",
        "orderStep": "INITIALIZATION",
        "orderType": "B_2_B_BOX",
        "updateChannel": "PUBLIC_PORTAL",
        "orderContent": {
            "B2BBoxOrder": {
                "delivery": "false",
                "iccid": [
                    "${#TestCase#iccid1}",
                    "${#TestCase#iccid2}"
                ]
            }
        }
    }
}</con:request><con:originalUri>http://DEV-b2b-ainst1.scartel.dc/coms-web/api/createOrder</con:originalUri><con:assertion type="JsonPath Existence Match" id="22e8402c-1548-4364-8b4b-0f0a592e3d04" name="Check for existence of [orderId]"><con:configuration><path>$.order.orderId</path><content>true</content><allowWildcards>false</allowWildcards><ignoreNamspaceDifferences>false</ignoreNamspaceDifferences><ignoreComments>false</ignoreComments></con:configuration></con:assertion><con:credentials><con:selectedAuthProfile>No Authorization</con:selectedAuthProfile><con:authType>No Authorization</con:authType></con:credentials><con:jmsConfig JMSDeliveryMode="PERSISTENT"/><con:jmsPropertyConfig/><con:parameters/></con:restRequest></con:config></con:testStep><con:testStep type="groovy" name="boxOrderSave" id="a01acf00-bade-4a18-a7f3-b7b42131c6f5"><con:settings/><con:config><script>def orderId = context.expand( '${B_2_B_BOX_order#Response#$.order.orderId}' )

def path = context.expand( '${#TestCase#Path}' )
def startDate = new Date()
testRunner.testCase.setPropertyValue( "box",orderId);

def out= new File(path+'B2BBOX'+orderId+'.txt')
int counter = context.expand( '${#TestCase#SIMCount}' ).toInteger()

for(int i = 1; i&lt;=counter; i++){
	
	def iccid = context.expand( '${#TestCase#iccid'+i+'}' )
	 out &lt;&lt; '\n'+ "Дата выдачи: "+startDate.format("yyyy-MM-dd'T'HH:mm:ss")  +  " | ICCID: " + iccid + " | IMSI: 25011"+ iccid + " | OrderID: " + orderId 
	}
	

</script></con:config></con:testStep><con:properties><con:property><con:name>SIMCount</con:name><con:value>2</con:value></con:property><con:property><con:name>N</con:name><con:value>2</con:value></con:property><con:property><con:name>Path</con:name><con:value>C:/Projects/</con:value></con:property><con:property><con:name>iccid1</con:name><con:value>0201537573</con:value></con:property><con:property><con:name>iccid2</con:name><con:value>0224072067</con:value></con:property><con:property><con:name>iccid3</con:name><con:value/></con:property><con:property><con:name>iccid4</con:name><con:value/></con:property><con:property><con:name>iccid5</con:name><con:value/></con:property><con:property><con:name>iccid6</con:name><con:value/></con:property><con:property><con:name>iccid7</con:name><con:value/></con:property><con:property><con:name>iccid8</con:name><con:value/></con:property><con:property><con:name>iccid9</con:name><con:value/></con:property><con:property><con:name>iccid10</con:name><con:value/></con:property><con:property><con:name>iccid0</con:name><con:value/></con:property><con:property><con:name>box</con:name><con:value>444073</con:value></con:property><con:property><con:name>iccid11</con:name><con:value/></con:property><con:property><con:name>iccid12</con:name><con:value/></con:property><con:property><con:name>iccid13</con:name><con:value/></con:property><con:property><con:name>iccid14</con:name><con:value/></con:property><con:property><con:name>iccid15</con:name><con:value/></con:property><con:property><con:name>iccid16</con:name><con:value/></con:property><con:property><con:name>iccid17</con:name><con:value/></con:property><con:property><con:name>iccid18</con:name><con:value/></con:property><con:property><con:name>iccid19</con:name><con:value/></con:property><con:property><con:name>iccid20</con:name><con:value/></con:property></con:properties><con:reportParameters/><con:breakPoints><con:testStepId>e07c3d59-4ad1-494e-9fb5-5989d27a038b</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>bcb0228b-1970-4979-9423-4eea885c56d9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>512f5807-e3cb-4535-9f1e-c20e9f8faa71</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>29319c2c-c939-4b1c-8fdb-f3b0680a5ac9</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>74a97fc7-4445-429a-abbb-8585d5884e4b</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>5fea992c-347c-4db0-a5ac-0919eac490c6</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>89f28699-1053-49c2-8b5e-c6f4d5e9f092</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>83122393-40a4-451d-b8ed-32e3a894defc</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d2feb4ae-55e4-4410-9186-68580bb15541</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>263084aa-7ba3-40fa-a8d0-825346f2a846</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>925a8b9a-aa75-40af-a209-bc13e4dfc512</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>4a3c40c8-cb86-40a9-b8c3-401c9224d619</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d56abaac-7c8f-4b5a-b61b-3c2f57a48f6d</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>d92ff283-405f-434f-b198-2726a03287db</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>ed913833-94ac-489f-a9e7-8d857138e33c</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>05484e49-753a-4f04-bf91-5efec03dcc25</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>82ba871d-dd6a-47a0-a37c-39c2603f2317</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints><con:breakPoints><con:testStepId>cdc8f8a5-4b76-47a5-8fba-44b2b4e4638b</con:testStepId><con:status>NONE</con:status><con:properties/></con:breakPoints></con:testCase>